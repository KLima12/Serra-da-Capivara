{% extends "base.html" %} {% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    {% block css %}
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/styleGaleria.css' %}"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../media/icon/logo-icon.png" />
    <title>{{ category.name }}</title>
    {% endblock %}
  </head>
  <body>
    {% block 'dashboard' %}
    <div class="center">
      <h1 class="cabecalho">{{ category.name }}</h1>
      <a href="{% url 'carrinho' %}">
        <img src="../../../media/icon/cart.svg" class="cart-ico" />
      </a>
    </div>

    <div class="category-button-container-horizontal">
      <div class="view-product-container">
        <div class="view-product-vertical">
          <div class="view-product-vertical">
            <h2 class="view-product-text">{{ product.name }}</h2>
            <div class="view-product-horizontal">
              <h6 class="view-product-text">Tamanho: {{ product.size }}</h6>
              <h6 class="view-product-text">CÃ³digo: {{ product.code }}</h6>
            </div>
          </div>

          <div class="view-product-horizontal">
            <div class="view-product-vertical">
              {% for photo in product.photos %}

              <img
                src="../../../media/{{ photo }}"
                alt="Imagem de {{ product.name }}"
                class="view-product-img"
              />

              {% endfor %}
            </div>

            <section class="img-zoom-container">
              <img
                src="../../../media/{{ product.photos.0 }}"
                alt="Imagem de {{ product.name }}"
                class="view-product-img-selected"
              />

              <div class="zoom-lens"></div>
            </section>

            <div class="zoomed-image"></div>
          </div>

          <button
            class="btn btn-cart btn-edit"
            data-product-id="{{ product.id }}"
          >
            <img src="../../../media/icon/cart.svg" class="cart-ico-button" />

            <span>Adicionar ao Carrinho</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const lens = document.querySelector(".zoom-lens");
        const imgContainer = document.querySelector(".img-zoom-container");
        const selectedImgs = document.querySelectorAll(
          ".view-product-img-selected"
        );
        const zoomedImg = document.querySelector(".zoomed-image");
        const thumbnails = document.querySelectorAll(".view-product-img");

        if (lens && selectedImgs.length > 0 && zoomedImg) {
          function magnify(selectedImgs, zoomedImg) {
            lens.addEventListener("mousemove", moveLens);

            selectedImgs.forEach((selectedImg) => {
              selectedImg.addEventListener("mousemove", (e) =>
                moveLens(e, selectedImg)
              );
            });

            imgContainer.addEventListener("mouseleave", leaveLens);
          }

          function moveLens(e, selectedImg) {
            let x, y, cx, cy;

            const selectedImg_rect = selectedImg.getBoundingClientRect();
            x = e.pageX - selectedImg_rect.left - lens.offsetWidth / 2;
            y = e.pageY - selectedImg_rect.top - lens.offsetHeight / 2;

            let max_xpos = selectedImg_rect.width - lens.offsetWidth;
            let max_ypos = selectedImg_rect.height - lens.offsetHeight;

            if (x > max_xpos) x = max_xpos;
            if (x < 0) x = 0;

            if (y > max_ypos) y = max_ypos;
            if (y < 0) y = 0;

            lens.style.top = `${y}px`;
            lens.style.left = `${x}px`;

            cx = zoomedImg.offsetWidth / lens.offsetWidth;
            cy = zoomedImg.offsetHeight / lens.offsetHeight;

            zoomedImg.style.background = `url('${selectedImg.src}') -${
              x * cx
            }px -${y * cy}px / ${selectedImg_rect.width * cx}px ${
              selectedImg_rect.height * cy
            }px no-repeat`;

            lens.classList.add("active");
            zoomedImg.classList.add("active");
          }

          function leaveLens() {
            lens.classList.remove("active");
            zoomedImg.classList.remove("active");
          }

          magnify(selectedImgs, zoomedImg);
        }

        const selectedImg = document.querySelector(
          ".view-product-img-selected"
        );
        thumbnails.forEach((thumbnail) => {
          thumbnail.addEventListener("click", () => {
            selectedImg.src = thumbnail.src;
          });
        });

        document.querySelectorAll(".product-card").forEach((card) => {
          card.addEventListener("click", () => {
            const productId = card.getAttribute("data-product-id");

            fetch(`/update-views/${productId}/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
              },
              body: JSON.stringify({ id: productId }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  const viewsText = card.querySelector(".product-views-text");
                  viewsText.textContent = data.new_views;
                }
              })
              .catch((error) => console.error("Error:", error));
          });
        });
      });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      function sendCartDataToServer() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        fetch('{% url "save_cart" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ cart: cart }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              window.open('{% url "message" %}', "_blank");
            } else {
              console.error("Error:", data);
            }
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      }

      function sendCartDataToServerCarrinho() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        fetch('{% url "save_cart" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ cart: cart }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              window.open('{% url "carrinho" %}', "_blank");
            } else {
              console.error("Error:", data);
            }
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      }

      document.addEventListener("DOMContentLoaded", function () {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        document.querySelectorAll(".btn-cart").forEach((button) => {
          const productId = button.getAttribute("data-product-id");

          let productInCart = cart.find((item) => item.id === productId);

          if (productInCart) {
            button.classList.remove("btn-edit");
            button.classList.add("btn-cart-check");
            button.querySelector("img").src = "../../../media/icon/check.svg";
            button.querySelector("span").textContent = "Produto Adicionado";
            button.disabled = true;
          }

          button.addEventListener("click", function () {
            if (productInCart) {
              cart = cart.filter((item) => item.id !== productId);
            } else {
              cart.push({ id: productId, quantity: 1 });
            }

            localStorage.setItem("cart", JSON.stringify(cart));

            productInCart = cart.find((item) => item.id === productId);
            if (productInCart) {
              button.classList.remove("btn-edit");
              button.classList.add("btn-cart-check");
              button.querySelector("img").src = "../../../media/icon/check.svg";
              button.querySelector("span").textContent = "Produto Adicionado";
              button.disabled = true;
            } else {
              button.classList.remove("btn-cart-check");
              button.classList.add("btn-edit");
              button.querySelector("img").src = "../../../media/icon/cart.svg";
              button.querySelector("span").textContent =
                "Adicionar ao Carrinho";
            }
          });
        });
      });
    </script>

    {% endblock %}
  </body>
</html>
